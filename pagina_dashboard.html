<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leitura DHT11 — ESP8266</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --card-radius:12px; }
    html,body{ height:100%; }
    body{ margin:0; padding:20px; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:linear-gradient(180deg,#f5f9ff 0,#ffffff 60%); color:#0b2540 }
    .app-shell{ max-width:1100px; margin:10px auto }
    .logo{ width:44px; height:44px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; background:linear-gradient(135deg,#3b82f6,#06b6d4); color:white }
    .card-modern{ border:0; border-radius:var(--card-radius); box-shadow:0 10px 25px rgba(12,35,63,0.06); overflow:hidden }
    .grid{ display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr } .right-col{ order:2 } }
    .chart-area{ padding:16px; border-radius:10px; background:linear-gradient(180deg,#ffffff,#fbfdff) }
    .chart-box{ width:100%; height:360px; display:flex; align-items:center; justify-content:center }
    canvas{ width:100% !important; height:100% !important }
    .mini-card{ padding:12px; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(12,35,63,0.04); }
    pre#log{ background:transparent; border:0; margin:0; height:240px; overflow:auto; font-size:0.8rem; }
    .nav-tabs .nav-link { color: #6b7280; }
    .nav-tabs .nav-link.active { color: #0b2540; font-weight: 600; }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-3">
        <div class="logo">D</div>
        <div>
          <div style="font-weight:700;">Leitura DHT (ESP8266)</div>
          <div style="font-size:0.85rem;color:#6b7280">Temperatura + Umidade — UI atualizada</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <div class="text-end me-2">
          <div style="font-size:0.8rem;color:#6b7280">Status</div>
          <div id="connBadge" class="badge bg-secondary">Iniciando</div>
        </div>
        <div>
          <button id="btnSettings" class="btn btn-primary btn-sm" title="Configurações"><i class="bi bi-gear-fill me-1"></i> Configurar</button>
        </div>
      </div>
    </div>

    <div class="card card-modern">
      <div class="card-body">
        <div class="grid">
          <div class="chart-area">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div style="font-size:0.85rem;color:#6b7280">Leitura Atual (Live)</div>
                <div class="d-flex align-items-baseline gap-2">
                  <div id="displayTemp" style="font-weight:800;font-size:1.5rem">— °C</div>
                  <div id="displayHum" style="font-size:1rem;color:#6b7280">— %</div>
                </div>
                <div id="displaySaved" class="mt-1" style="font-size:0.9rem; color:#0a58ca; font-weight: 500;"></div>
              </div>
              <div class="text-end">
                <div style="font-size:0.85rem;color:#6b7280">Atualizado</div>
                <div id="displayTime" style="color:#6b7280">—</div>
              </div>
            </div>

            <div class="chart-box mini-card">
              <canvas id="mainChart" aria-label="Gráfico de temperatura e umidade" role="img"></canvas>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3" style="font-size:0.9rem;color:#6b7280">
              <div>Histórico (local): <span id="pointsCount">0</span> pontos</div>
              <div>Mín/TMáx/Média (Temp): <strong id="minVal">—</strong> / <strong id="maxVal">—</strong> / <strong id="avgVal">—</strong></div>
            </div>
          </div>

          <div class="right-col">
            <div class="mini-card mb-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="d-flex align-items-baseline gap-2">
                    <div style="font-size:0.85rem;color:#6b7280">Endpoint</div>
                    <small class="text-muted ms-2" id="endpointHint">(ESP: /status ou DB: /get_ultimo.php)</small>
                  </div>
                  <div style="font-weight:600;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="endpointLabel">...</div>
                </div>
                <div class="d-flex flex-column align-items-end">
                  <div class="d-flex gap-1">
                    <button id="btnCopy" class="btn btn-sm btn-outline-secondary" title="Copiar endpoint"><i class="bi bi-clipboard"></i></button>
                    <button id="btnEdit" class="btn btn-sm btn-outline-secondary" title="Editar endpoint"><i class="bi bi-pencil"></i></button>
                  </div>
                </div>
              </div>
            </div>

            <ul class="nav nav-tabs" id="infoTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-controles-btn" data-bs-toggle="tab" data-bs-target="#tab-controles" type="button" role="tab">Controles</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-resumo-btn" data-bs-toggle="tab" data-bs-target="#tab-resumo" type="button" role="tab">Resumo</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-logs-btn" data-bs-toggle="tab" data-bs-target="#tab-logs" type="button" role="tab">Logs</button>
              </li>
            </ul>

            <div class="tab-content mini-card" id="infoTabsContent" style="border-top-left-radius: 0;">
              
              <div class="tab-pane fade show active" id="tab-controles" role="tabpanel">
                <div class="d-grid gap-2">
                  <div class="d-flex gap-2">
                    <button id="btnToggle" class="btn btn-primary btn-sm" style="flex:1"><i class="bi bi-pause-fill me-1"></i><span id="btnToggleText">Pausar</span></button>
                    <button id="btnRetry" class="btn btn-outline-primary btn-sm"><i class="bi bi-arrow-repeat me-1"></i>Forçar</button>
                    <button id="btnClear" class="btn btn-outline-secondary btn-sm"><i class="bi bi-trash me-1"></i>Limpar</button>
                  </div>
                  <small class="text-muted text-center">Intervalo, thresholds e outros estão em "Configurar".</small>
                </div>
              </div>

              <div class="tab-pane fade" id="tab-resumo" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div style="color:#6b7280">Resumo rápido</div>
                  <div style="color:#6b7280">Últimos <span id="summaryCount">0</span></div>
                </div>
                <div class="d-flex flex-column gap-2">
                  <div class="d-flex justify-content-between"><div style="color:#6b7280">Último (Temp)</div><div id="summaryLast">— °C</div></div>
                  <div class="d-flex justify-content-between"><div style="color:#6b7280">Min</div><div id="summaryMin">—</div></div>
                  <div class="d-flex justify-content-between"><div style="color:#6b7280">Max</div><div id="summaryMax">—</div></div>
                  <div class="d-flex justify-content-between"><div style="color:#6b7280">Média</div><div id="summaryAvg">—</div></div>
                </div>
                <hr>
                <div style="color:#6b7280">Sparkline (Temp)</div>
                <div style="height:72px"><canvas id="sparkChart"></canvas></div>
              </div>

              <div class="tab-pane fade" id="tab-logs" role="tabpanel">
                <pre id="log">Iniciando...</pre>
              </div>
            </div>
          </div>
        </div>

        <footer style="margin-top:16px;text-align:center;color:#475569;font-size:0.9rem">Feito com ❤️ — clique em "Configurar" para personalizar o endpoint e thresholds.</footer>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Configurações</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <nav>
            <div class="nav nav-tabs" id="nav-tab-modal" role="tablist">
              <button class="nav-link active" id="nav-con-tab" data-bs-toggle="tab" data-bs-target="#nav-con" type="button" role="tab">Conexão</button>
              <button class="nav-link" id="nav-esp-tab" data-bs-toggle="tab" data-bs-target="#nav-esp" type="button" role="tab">ESP8266</button>
              <button class="nav-link" id="nav-dash-tab" data-bs-toggle="tab" data-bs-target="#nav-dash" type="button" role="tab">Dashboard</button>
              <button class="nav-link" id="nav-notify-tab" data-bs-toggle="tab" data-bs-target="#nav-notify" type="button" role="tab">Notificações</button>
            </div>
          </nav>
          <div class="tab-content p-3 border border-top-0 rounded-bottom" id="nav-tabContent-modal">
            
            <div class="tab-pane fade show active" id="nav-con" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">Endpoint do ESP (get_ultimo / status)</label>
                <input id="modalEndpoint" class="form-control" placeholder="http://192.168.x.x/status" />
              </div>
              <div class="mb-3">
                <label class="form-label">Intervalo de leitura (ms)</label>
                <input id="modalInterval" type="number" class="form-control" />
              </div>
            </div>

            <div class="tab-pane fade" id="nav-esp" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">Threshold temperatura (°C) — ex: 2.0</label>
                <input id="modalTempThreshold" type="number" step="0.1" class="form-control" />
                <div class="form-text">Define no ESP quando ele deve salvar no DB.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Threshold umidade (%) — ex: 10</label>
                <input id="modalHumThreshold" type="number" step="0.1" class="form-control" />
              </div>
            </div>

            <div class="tab-pane fade" id="nav-dash" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">Máx pontos no gráfico</label>
                <input id="modalMaxPoints" type="number" class="form-control" min="4" max="240" />
              </div>
              <div class="mb-3">
                <label class="form-label">Usar fallback em erro</label>
                <select id="modalFallback" class="form-select">
                  <option value="off">Desligado</option>
                  <option value="random">Random (Temp/Umid)</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Tentativas até offline</label>
                <input id="modalMaxFails" type="number" class="form-control" min="1" max="10" />
              </div>
            </div>

            <div class="tab-pane fade" id="nav-notify" role="tabpanel">
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="modalNotifyEnabled" value="1">
                <label class="form-check-label" for="modalNotifyEnabled">Ativar notificações WhatsApp (CallMeBot)</label>
              </div>
              <div class="mb-3">
                <label class="form-label">Telefone (ex: +5511...)</label>
                <input id="modalNotifyPhone" class="form-control" placeholder="+55119..." />
              </div>
              <div class="mb-3">
                <label class="form-label">API Key (CallMeBot)</label>
                <input id="modalNotifyApikey" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">Template da Mensagem</label>
                <textarea id="modalNotifyTemplate" class="form-control" rows="2"></textarea>
                <div class="form-text">Placeholders: {temp}, {hum}, {datahora}, {id}</div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Notificar temp ≥</label>
                  <input id="modalNotifyTempAbove" type="number" step="0.1" class="form-control" placeholder="Opcional" />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Notificar hum ≥</label>
                  <input id="modalNotifyHumAbove" type="number" step="0.1" class="form-control" placeholder="Opcional" />
                </div>
              </div>
              <button type="button" id="btnTestNotify" class="btn btn-outline-success btn-sm">Testar Envio</button>
              <div id="notifyTestResult" class="mt-2" style="font-size: 0.85rem;"></div>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="modalSave" class="btn btn-primary" data-bs-dismiss="modal">Salvar e Aplicar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function(){
    // ---------- CONFIG (valores iniciais) ----------
    const DEFAULT_ENDPOINT = 'http://192.168.137.78/status';
    const DEFAULT_INTERVAL = 4000;
    const DEFAULT_MAX_POINTS = 12;
    const DEFAULT_MAX_FAILS = 3;
    const DEFAULT_TEMP_THRESHOLD = 2.0;
    const DEFAULT_HUM_THRESHOLD = 10.0;
    // NOVO: URL base da API de notificação (assume estar no mesmo servidor)
    let NOTIFY_API_URL = ''; 

    // Estado
    let running = true;
    let failCount = 0;
    let offline = false;
    let readings = [];
    let timer = null;

    // Elementos (Dashboard)
    const endpointLabel = document.getElementById('endpointLabel');
    const displayTemp = document.getElementById('displayTemp');
    const displayHum = document.getElementById('displayHum');
    const displayTime = document.getElementById('displayTime');
    const displaySaved = document.getElementById('displaySaved');
    const connBadge = document.getElementById('connBadge');
    const logEl = document.getElementById('log');
    const btnToggle = document.getElementById('btnToggle');
    const btnToggleText = document.getElementById('btnToggleText');
    const btnRetry = document.getElementById('btnRetry');
    const btnClear = document.getElementById('btnClear');
    const btnCopy = document.getElementById('btnCopy');
    const btnEdit = document.getElementById('btnEdit');
    const btnSettings = document.getElementById('btnSettings');
    const summaryCount = document.getElementById('summaryCount');
    const summaryLast = document.getElementById('summaryLast');
    const summaryMin = document.getElementById('summaryMin');
    const summaryMax = document.getElementById('summaryMax');
    const summaryAvg = document.getElementById('summaryAvg');
    const pointsCount = document.getElementById('pointsCount');
    const minVal = document.getElementById('minVal');
    const maxVal = document.getElementById('maxVal');
    const avgVal = document.getElementById('avgVal');

    // Elementos (Modal)
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const modalEndpoint = document.getElementById('modalEndpoint');
    const modalInterval = document.getElementById('modalInterval');
    const modalFallback = document.getElementById('modalFallback');
    const modalTempThreshold = document.getElementById('modalTempThreshold');
    const modalHumThreshold = document.getElementById('modalHumThreshold');
    const modalMaxPoints = document.getElementById('modalMaxPoints');
    const modalMaxFails = document.getElementById('modalMaxFails');
    const modalSave = document.getElementById('modalSave');

    // NOVO: Elementos (Modal de Notificação)
    const modalNotifyEnabled = document.getElementById('modalNotifyEnabled');
    const modalNotifyPhone = document.getElementById('modalNotifyPhone');
    const modalNotifyApikey = document.getElementById('modalNotifyApikey');
    const modalNotifyTemplate = document.getElementById('modalNotifyTemplate');
    const modalNotifyTempAbove = document.getElementById('modalNotifyTempAbove');
    const modalNotifyHumAbove = document.getElementById('modalNotifyHumAbove');
    const btnTestNotify = document.getElementById('btnTestNotify');
    const notifyTestResult = document.getElementById('notifyTestResult');

    // load settings from localStorage
    function loadSettings(){
      const s = JSON.parse(localStorage.getItem('esp_settings')||'{}');
      return {
        endpoint: s.endpoint || DEFAULT_ENDPOINT,
        interval: s.interval || DEFAULT_INTERVAL,
        maxPoints: s.maxPoints || DEFAULT_MAX_POINTS,
        fallback: s.fallback || 'off',
        maxFails: s.maxFails || DEFAULT_MAX_FAILS,
        tempThreshold: (s.tempThreshold !== undefined) ? s.tempThreshold : DEFAULT_TEMP_THRESHOLD,
        humThreshold:  (s.humThreshold  !== undefined) ? s.humThreshold  : DEFAULT_HUM_THRESHOLD
      };
    }
    function saveSettings(settings){ localStorage.setItem('esp_settings', JSON.stringify(settings)); }

    let settings = loadSettings();

    // UI populate
    function populateUI(){
      endpointLabel.innerText = settings.endpoint;
      modalEndpoint.value = settings.endpoint;
      modalInterval.value = settings.interval;
      modalFallback.value = settings.fallback;
      modalMaxPoints.value = settings.maxPoints;
      modalMaxFails.value = settings.maxFails;
      modalTempThreshold.value = settings.tempThreshold;
      modalHumThreshold.value = settings.humThreshold;
      
      // NOVO: Define a URL da API de notificação (baseado no endpoint)
      try {
        const urlObj = new URL(settings.endpoint);
        const base = urlObj.origin; // http://192.168.x.x
        // Assume que a API está na raiz do servidor, ou ajuste o caminho
        NOTIFY_API_URL = `${base}/notify_admin.php`; 
        // Se estiver na mesma subpasta (ex: /Arduino/):
        // const path = urlObj.pathname.substring(0, urlObj.pathname.lastIndexOf('/'));
        // NOTIFY_API_URL = `${base}${path}/notify_admin.php`;
        log('URL da API de Notificação: ' + NOTIFY_API_URL);
      } catch (e) {
        log('Endpoint inválido, não foi possível definir URL da API de Notificação');
      }
    }
    populateUI();

    // ---------- Chart.js setup ----------
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    function createGradient(ctx){
      const g = ctx.createLinearGradient(0,0,0,400);
      g.addColorStop(0, 'rgba(255,99,132,0.18)');
      g.addColorStop(1, 'rgba(255,99,132,0.02)');
      return g;
    }
    const mainConfig = {
      type: 'line',
      data: { labels: [], datasets:[
        { label:'Temperatura (°C)', data:[], fill:true, tension:0.3, pointRadius:4, borderWidth:2, yAxisID: 'y_temp', backgroundColor: null, borderColor: 'rgba(255,99,132,1)' },
        { label:'Umidade (%)', data:[], fill:false, tension:0.3, pointRadius:2, borderWidth:2, yAxisID: 'y_hum', borderColor: 'rgba(54,162,235,1)' }
      ] },
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{mode:'index', intersect:false},
        plugins:{ legend:{display:true}, tooltip:{callbacks:{label:ctx=> `${ctx.dataset.label}: ${ctx.formattedValue} ${ctx.dataset.label.includes('Umidade')?'%':'°C'}`}}},
        scales:{ x:{ display:true, grid:{display:false}}, y_temp:{ position:'left', beginAtZero:true, suggestedMin:0, suggestedMax:50, title:{display:true, text:'°C'} }, y_hum:{ position:'right', beginAtZero:true, suggestedMin:0, suggestedMax:100, grid:{display:false}, title:{display:true, text:'%'} } }
      }
    };
    const mainChart = new Chart(mainCtx, mainConfig);
    const sparkCtx = document.getElementById('sparkChart').getContext('2d');
    const sparkConfig = { type:'line', data:{ labels:[], datasets:[{ data:[], fill:false, tension:0.5, pointRadius:0, borderWidth:1 }] }, options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} } };
    const sparkChart = new Chart(sparkCtx, sparkConfig);
    function refreshGradients(){ mainChart.data.datasets[0].backgroundColor = createGradient(mainCtx); mainChart.update('none'); }
    refreshGradients();

    // ---------- helpers ----------
    function log(msg){ const now = new Date().toLocaleTimeString(); logEl.textContent = `[${now}] ${msg}\n` + logEl.textContent; }
    function setBadge(text, variant='secondary'){ connBadge.className = 'badge bg-' + variant; connBadge.innerText = text; }
    function statsFromData(arr, key){
      if(!arr.length) return {min:NaN,max:NaN,avg:NaN,last:NaN};
      const vals = arr.map(r=> r[key]);
      const min = Math.min(...vals); const max = Math.max(...vals);
      const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
      return {min,max,avg,last:vals[vals.length-1]};
    }

    function pushReading(temp, hum, savedTemp, savedHum){
      const now = new Date();
      readings.push({t:now, temp: Number(temp), hum: Number(hum)});
      if(readings.length > Number(settings.maxPoints)) readings.shift();

      mainChart.data.labels = readings.map(r=> new Date(r.t).toLocaleTimeString());
      mainChart.data.datasets[0].data = readings.map(r=> r.temp);
      mainChart.data.datasets[1].data = readings.map(r=> r.hum);
      mainChart.update('active');
      sparkChart.data.labels = readings.map((r,i)=>i);
      sparkChart.data.datasets[0].data = readings.map(r=> r.temp);
      sparkChart.update('none');

      const s = statsFromData(readings, 'temp');
      displayTemp.innerText = isNaN(s.last) ? '— °C' : s.last.toFixed(1) + ' °C';
      displayHum.innerText = isNaN(readings[readings.length-1]?.hum) ? '— %' : readings[readings.length-1].hum.toFixed(1) + ' %';
      displayTime.innerText = now.toLocaleString();
      
      if (savedTemp !== undefined && !isNaN(savedTemp)){
        displaySaved.innerHTML = `<i class="bi bi-database-check"></i> Último salvo: <strong>${Number(savedTemp).toFixed(1)} °C</strong> / <strong>${Number(savedHum).toFixed(1)} %</strong>`;
      } else {
        displaySaved.innerHTML = '';
      }

      pointsCount.innerText = readings.length;
      minVal.innerText = isNaN(s.min)?'—': s.min.toFixed(1)+' °C';
      maxVal.innerText = isNaN(s.max)?'—': s.max.toFixed(1)+' °C';
      avgVal.innerText = isNaN(s.avg)?'—': s.avg.toFixed(1)+' °C';
      summaryCount.innerText = readings.length;
      summaryLast.innerText = isNaN(s.last)?'—': s.last.toFixed(1)+' °C';
      summaryMin.innerText = isNaN(s.min)?'—': s.min.toFixed(1)+' °C';
      summaryMax.innerText = isNaN(s.max)?'—': s.max.toFixed(1)+' °C';
      summaryAvg.innerText = isNaN(s.avg)?'—': s.avg.toFixed(1)+' °C';

      log(`Leitura -> Temp: ${Number(temp).toFixed(1)} °C, Umid: ${Number(hum).toFixed(1)} %`);
    }

    // ---------- network (leitura) ----------
    async function fetchFromESP(){
      const url = settings.endpoint + (settings.endpoint.includes('?') ? '&_ts=' + Date.now() : '?_ts=' + Date.now());
      const controller = new AbortController();
      const timeout = setTimeout(()=> controller.abort(), 7000);

      try {
        const resp = await fetch(url, { cache: 'no-store', mode: 'cors', signal: controller.signal });
        clearTimeout(timeout);
        if (!resp.ok) { const txt = await resp.text().catch(()=>'<no-body>'); throw new Error('HTTP ' + resp.status + ': ' + txt); }

        let json;
        try { json = await resp.json(); } catch (e) { throw new Error('Resposta não-JSON'); }

        const t = parseFloat(json.temperatura ?? json.latestTemp ?? json.temp ?? json.t ?? json.valor);
        const h = parseFloat(json.umidade ?? json.latestHum ?? json.hum ?? json.h ?? json.umidade);
        const st = parseFloat(json.saved_temp ?? NaN);
        const sh = parseFloat(json.saved_hum ?? NaN);

        if (isNaN(t) || isNaN(h)) throw new Error('JSON sem valores numéricos (t/h)');

        failCount = 0; offline = false;
        setBadge('Online','success');
        pushReading(t, h, st, sh);
      } catch (err) {
        clearTimeout(timeout);
        log('Erro: ' + (err.message || err));
        failCount++;
        setBadge('Erro ('+failCount+')','warning');

        if (settings.fallback === 'random') {
          const fallbackTemp = (Math.random()*20)+10;
          const fallbackHum = (Math.random()*60)+20;
          log('Inserindo fallback: ' + fallbackTemp.toFixed(1) + ' °C, ' + fallbackHum.toFixed(1) + ' %');
          pushReading(fallbackTemp, fallbackHum, NaN, NaN);
        } else {
          if (failCount >= Number(settings.maxFails)) {
            offline = true;
            setBadge('Offline','secondary');
            log('Marca offline depois de ' + failCount + ' falhas');
          }
        }
      }
    }
    function startLoop(){
      if(timer) clearInterval(timer);
      timer = setInterval(()=>{ if(running && !offline) fetchFromESP(); }, Number(settings.interval));
    }

    // ---------- NOVO: Funções da API de Notificação ----------
    async function loadNotificationSettings() {
      const url = `${NOTIFY_API_URL}?action=load&_ts=${Date.now()}`;
      notifyTestResult.innerHTML = '';
      try {
        log('Carregando config de notificação...');
        const resp = await fetch(url);
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.mensagem || 'HTTP ' + resp.status);
        
        if (json.status === 'ok' && json.config) {
          const cfg = json.config;
          modalNotifyEnabled.checked = cfg.enabled;
          modalNotifyPhone.value = cfg.phone || '';
          modalNotifyApikey.value = cfg.apikey || '';
          modalNotifyTemplate.value = cfg.template || '';
          modalNotifyTempAbove.value = cfg.notify_temp_above || '';
          modalNotifyHumAbove.value = cfg.notify_hum_above || '';
          log('Config de notificação carregada.');
        } else {
          throw new Error(json.mensagem || 'Resposta inválida');
        }
      } catch (e) {
        log('Erro ao carregar config de notificação: ' + e.message);
        notifyTestResult.innerHTML = `<div class="alert alert-danger p-2">Falha ao carregar config: ${e.message}</div>`;
      }
    }

    async function saveNotificationSettings() {
      const url = `${NOTIFY_API_URL}?action=save`;
      
      const formData = new FormData();
      formData.append('enabled', modalNotifyEnabled.checked ? '1' : '0');
      formData.append('phone', modalNotifyPhone.value);
      formData.append('apikey', modalNotifyApikey.value);
      formData.append('template', modalNotifyTemplate.value);
      formData.append('notify_temp_above', modalNotifyTempAbove.value);
      formData.append('notify_hum_above', modalNotifyHumAbove.value);
      
      try {
        log('Salvando config de notificação...');
        const resp = await fetch(url, { method: 'POST', body: formData });
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.mensagem || 'Erro HTTP ' + resp.status);
        
        log('Config de notificação salva: ' + json.mensagem);
        return true;
      } catch (e) {
        log('Erro ao salvar config de notificação: ' + e.message);
        return false;
      }
    }

    // ---------- UI actions (ATUALIZADO) ----------
    btnToggle.addEventListener('click', ()=>{
      running = !running; btnToggleText.innerText = running ? 'Pausar' : 'Continuar';
      btnToggle.querySelector('i').className = running ? 'bi bi-pause-fill me-1' : 'bi bi-play-fill me-1';
      setBadge(running ? (offline ? 'Offline' : 'Ativo') : 'Pausado', running ? (offline?'secondary':'success') : 'secondary');
    });

    btnRetry.addEventListener('click', ()=>{ offline=false; failCount=0; setBadge('Tentando','info'); fetchFromESP(); });
    btnClear.addEventListener('click', ()=>{ readings=[]; mainChart.data.labels=[]; mainChart.data.datasets[0].data=[]; mainChart.data.datasets[1].data=[]; sparkChart.data.labels=[]; sparkChart.data.datasets[0].data=[]; mainChart.update(); sparkChart.update(); displayTemp.innerText='— °C'; displayHum.innerText='— %'; displayTime.innerText='—'; displaySaved.innerHTML=''; log('Limpo histórico'); });
    btnCopy.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(settings.endpoint); log('Endpoint copiado para área de transferência'); }catch(e){ log('Não foi possível copiar: '+e); } });
    
    // ATUALIZADO: Abrir modal
    function openSettingsModal(){
      populateUI(); 
      loadNotificationSettings(); // Carrega configs de notificação
      editModal.show();
    }
    btnEdit.addEventListener('click', openSettingsModal);
    btnSettings.addEventListener('click', openSettingsModal);

    // ATUALIZADO: Salvar Modal
    modalSave.addEventListener('click', async ()=>{
      // Salva configs do Dashboard
      settings.endpoint = modalEndpoint.value || settings.endpoint;
      settings.interval = Number(modalInterval.value) || settings.interval;
      settings.fallback = modalFallback.value || settings.fallback;
      settings.maxPoints = Number(modalMaxPoints.value) || settings.maxPoints;
      settings.maxFails = Number(modalMaxFails.value) || settings.maxFails;
      settings.tempThreshold = parseFloat(modalTempThreshold.value) || settings.tempThreshold;
      settings.humThreshold  = parseFloat(modalHumThreshold.value)  || settings.humThreshold;
      saveSettings(settings);
      log('Configurações do dashboard salvas (local)');
      
      // Atualiza a UI principal
      populateUI();

      // Envia thresholds para o ESP (/config)
      try {
        const urlObj = new URL(settings.endpoint);
        const base = urlObj.origin; 
        const configUrl = `${base}/config?temp=${encodeURIComponent(settings.tempThreshold)}&hum=${encodeURIComponent(settings.humThreshold)}`;

        log('Enviando thresholds para ESP: ' + configUrl);
        const controller = new AbortController();
        const timeout = setTimeout(()=> controller.abort(), 5000);
        const resp = await fetch(configUrl, { method: 'GET', mode: 'cors', signal: controller.signal });
        clearTimeout(timeout);
        if (!resp.ok) { const t = await resp.text().catch(()=>''); throw new Error(t); }
        const j = await resp.json().catch(()=>null);
        log('ESP respondeu config: ' + (j ? JSON.stringify(j) : 'ok'));
      } catch (e) {
        log('Não foi possível enviar thresholds para ESP: ' + e);
      }
      
      // NOVO: Salva as configurações de notificação
      await saveNotificationSettings();
      
      startLoop(); // Reinicia o loop com o novo intervalo
    });

    // NOVO: Testar Notificação
    btnTestNotify.addEventListener('click', async () => {
      const url = `${NOTIFY_API_URL}?action=test`;
      notifyTestResult.innerHTML = `<div class="alert alert-info p-2">Enviando teste...</div>`;

      const formData = new FormData();
      formData.append('phone', modalNotifyPhone.value);
      formData.append('apikey', modalNotifyApikey.value);
      formData.append('template', modalNotifyTemplate.value);
      
      try {
        const resp = await fetch(url, { method: 'POST', body: formData });
        const json = await resp.json();
        if (!resp.ok) throw new Error(json.mensagem || 'Erro HTTP ' + resp.status);

        if (json.ok) {
          notifyTestResult.innerHTML = `<div class="alert alert-success p-2"><strong>Sucesso!</strong> Resposta: ${json.body || ''}</div>`;
          log('Teste de notificação OK.');
        } else {
          notifyTestResult.innerHTML = `<div class="alert alert-warning p-2"><strong>Falha.</strong> ${json.mensagem || json.error || json.body}</div>`;
          log('Teste de notificação falhou: ' + (json.mensagem || json.error || json.body));
        }

      } catch (e) {
        log('Erro no fetch do teste: ' + e.message);
        notifyTestResult.innerHTML = `<div class="alert alert-danger p-2">Erro de rede: ${e.message}</div>`;
      }
    });

    // iniciar
    setBadge('Iniciando','secondary');
    log('UI inicializada — endpoint: ' + settings.endpoint);
    startLoop();
    fetchFromESP(); // primeira leitura imediata
    window.addEventListener('resize', ()=>{ refreshGradients(); });
  });
  </script>
</body>
</html>