<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leitura de Tensão - ESP8266</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#eef2f6; padding:28px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .card-center{ max-width:420px; margin:24px auto; }
    .chart-box{ width:360px; max-width:90vw; aspect-ratio:1/1; margin:0 auto; padding:12px;
               background:#fff; border-radius:12px; box-shadow:0 6px 18px rgba(12,35,63,0.08);
               display:flex; align-items:center; justify-content:center; }
    canvas{ width:100% !important; height:100% !important; }
    .big-value{ font-weight:700; font-size:1.4rem; }
  </style>
</head>
<body>
  <div class="card card-center">
    <div class="card-body">
      <h5 class="card-title mb-3">Tensão (ESP8266)</h5>
      <div class="chart-box"><canvas id="meuGrafico" aria-label="Gráfico de tensão" role="img"></canvas></div>

      <div class="d-flex justify-content-between align-items-center mt-3">
        <div><div class="small text-muted">Último valor</div><div id="ultimoValor" class="big-value">— V</div></div>
        <div class="text-end"><div class="small text-muted">Atualizado</div><div id="ultimoHorario">—</div></div>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button id="btnToggle" class="btn btn-outline-primary btn-sm">Pausar</button>
        <button id="btnRetry" class="btn btn-outline-secondary btn-sm">Forçar leitura</button>
        <button id="btnClear" class="btn btn-outline-secondary btn-sm">Limpar</button>
        <div class="ms-auto"><small class="text-muted">Endpoint:</small><div style="max-width:160px"><small id="endpointLabel"></small></div></div>
      </div>

      <div class="status mt-2"><small id="statusText" class="text-muted">Iniciando...</small></div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const ESP_ENDPOINT = "http://192.168.137.180/dados"; // <-- substitua pelo IP do seu ESP
    const UPDATE_INTERVAL = 6000;       // intervalo entre leituras (ms)
    const ANIMATION_DURATION = 4500;    // duração da animação do Chart.js (ms)
    const MAX_POINTS = 12;              // quantos pontos manter no gráfico
    const MAX_FAILS_BEFORE_OFFLINE = 3; // quantas falhas até marcar offline
    const USE_FALLBACK_ON_ERROR = false; // se true, insere valor aleatório ao falhar (não recomendado)

    // ========== UI refs ==========
    document.getElementById('endpointLabel').innerText = ESP_ENDPOINT;
    const ultimoValorEl = document.getElementById('ultimoValor');
    const ultimoHorarioEl = document.getElementById('ultimoHorario');
    const statusText = document.getElementById('statusText');
    const btnToggle = document.getElementById('btnToggle');
    const btnRetry = document.getElementById('btnRetry');
    const btnClear = document.getElementById('btnClear');

    // ========== Chart setup ==========
    const labels = [];
    const data = {
      labels,
      datasets: [{
        label: 'Tensão (V)',
        data: [],
        fill: true,
        tension: 0.35,
        pointRadius: 3,
        backgroundColor: 'rgba(54,162,235,0.15)',
        borderColor: 'rgba(54,162,235,1)',
        borderWidth: 2
      }]
    };

    const config = {
      type: 'line',
      data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: ANIMATION_DURATION, easing: 'linear' },
        plugins: { legend: { display: false } },
        scales: {
          x: { display: false },
          y: { beginAtZero: true, suggestedMax: 3.6, title: { display: true, text: 'Volts' } }
        }
      }
    };

    const ctx = document.getElementById('meuGrafico').getContext('2d');
    const meuGrafico = new Chart(ctx, config);

    // ========== state ==========
    let running = true;
    let failCount = 0;
    let offline = false;

    btnToggle.addEventListener('click', () => {
      running = !running;
      btnToggle.innerText = running ? 'Pausar' : 'Continuar';
      statusText.innerText = running ? (offline ? 'Offline — aguardando reconexão' : 'Atualizações ativas') : 'Atualizações pausadas';
    });

    btnClear.addEventListener('click', () => {
      data.labels.length = 0;
      data.datasets[0].data.length = 0;
      meuGrafico.update();
      ultimoValorEl.innerText = '— V';
      ultimoHorarioEl.innerText = '—';
    });

    btnRetry.addEventListener('click', () => {
      // força uma tentativa imediata mesmo que esteja offline
      offline = false;
      failCount = 0;
      statusText.innerText = 'Tentando...';
      fetchFromESP();
    });

    function pushValue(value) {
      const label = new Date().toLocaleTimeString();
      data.labels.push(label);
      data.datasets[0].data.push(value);
      if (data.labels.length > MAX_POINTS) { data.labels.shift(); data.datasets[0].data.shift(); }
      meuGrafico.update('active');
      ultimoValorEl.innerText = value.toFixed(2) + ' V';
      ultimoHorarioEl.innerText = new Date().toLocaleString();
    }

    async function fetchFromESP() {
      try {
        const resp = await fetch(ESP_ENDPOINT, { cache: "no-store" });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const v = parseFloat(json.tensao);
        if (isNaN(v)) throw new Error('valor inválido no JSON');
        // sucesso
        failCount = 0;
        offline = false;
        statusText.innerText = 'Recebido do ESP';
        statusText.className = 'text-success';
        pushValue(v);
      } catch (err) {
        // falha ao buscar do ESP
        failCount++;
        console.warn('Erro ao buscar do ESP:', err);
        statusText.innerText = `Erro ao ler ESP (${failCount}/${MAX_FAILS_BEFORE_OFFLINE}): ${err.message || err}`;
        statusText.className = 'text-danger';

        if (USE_FALLBACK_ON_ERROR) {
          // comportamento opcional: inserir fallback (desligado por padrão)
          const fallback = (Math.random() * 3.3);
          pushValue(fallback);
          statusText.innerText += ' · fallback inserido';
        } else {
          // sem fallback: quando atingir o limite, marca offline e para de adicionar pontos
          if (failCount >= MAX_FAILS_BEFORE_OFFLINE) {
            offline = true;
            statusText.innerText = 'ESP offline — nenhum dado novo será adicionado. Verifique IP/CORS/ligação.';
            statusText.className = 'text-muted';
          }
        }
      }
    }

    // loop de atualização
    setInterval(() => {
      if (!running) return;
      if (offline) return; // não tenta se marcado offline (a menos que usuário pressione Forçar leitura)
      fetchFromESP();
    }, UPDATE_INTERVAL);

    // primeira tentativa imediata
    fetchFromESP();
  </script>
</body>
</html>
